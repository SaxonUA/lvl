<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>WoT Ultimate HUD ¬∑ Strict Logic</title>
  <style>
    :root {
      --accent: #00f2ff;
      --save-color: #ffaa00;
      --success-color: #00ff95;
      --fail-color: #ff3c3c;
      --card-bg: rgba(18, 21, 25, 0.95);
      --view-width: 600px;
      --card-width: 200px;
      --card-gap: -40px;
      --panel-shadow: 0 15px 35px rgba(0,0,0,0.7);
      --card-border: 1px solid rgba(255,255,255,0.1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: transparent;
      font-family: 'Arial', 'Helvetica', sans-serif;
      color: #fff;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .stats-bar {
      display: flex;
      gap: 5px;
      margin-bottom: 20px;
      z-index: 10;
    }
    .stat-box {
      background: var(--card-bg);
      border: var(--card-border);
      border-top: 3px solid var(--accent);
      padding: 10px 25px;
      border-radius: 10px;
      text-align: center;
      min-width: 130px;
      box-shadow: var(--panel-shadow);
    }
    .stat-box.orange-style { border-top: 3px solid var(--save-color); }
    .stat-box.orange-style .stat-value { color: var(--save-color); }
    .stat-label { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 5px; }
    .stat-value { font-family: 'Arial Black', sans-serif; font-size: 28px; font-weight: 900; color: var(--accent); }

    .viewport {
      width: var(--view-width);
      height: 300px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      mask-image: linear-gradient(to right, transparent 0%, black 20%, black 80%, transparent 100%);
      margin-bottom: 10px;
    }

    .card-row {
      display: flex;
      align-items: center;
      position: absolute;
      left: 0;
      transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
      padding-left: calc(var(--view-width) / 2 - var(--card-width) / 2);
    }

    .card {
      width: var(--card-width);
      height: 260px;
      background: var(--card-bg);
      border: var(--card-border);
      border-radius: 18px;
      margin-right: var(--card-gap);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px 15px;
      flex-shrink: 0;
      transition: all 0.6s ease;
      opacity: 0.2;
      transform: scale(0.85);
      filter: grayscale(1);
      position: relative;
      overflow: hidden;
    }

    .card.active { opacity: 1; transform: scale(1.1); border: 2px solid var(--accent); box-shadow: 0 0 50px rgba(0, 242, 255, 0.3); z-index: 50; filter: grayscale(0); }
    .card.is-save.active { border-color: var(--save-color); box-shadow: 0 0 50px rgba(255, 170, 0, 0.3); }
    .card.prev, .card.next { opacity: 0.5; transform: scale(0.95); filter: grayscale(0.5); z-index: 10; }

    /* –î–∏–∑–∞–π–Ω –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ –∫–∞—Ä—Ç–∫–∏ */
    .card-header { width: 100%; display: flex; justify-content: space-between; align-items: flex-start; height: 35px; margin-bottom: 5px; }
    .step-text { font-family: 'Arial Black', sans-serif; font-size: 10px; color: var(--accent); text-transform: uppercase; text-align: left; }
    .is-save .step-text { color: var(--save-color); }
    .save-label { font-size: 9px; font-weight: 900; color: var(--save-color); text-transform: uppercase; text-align: center; flex-grow: 1; margin-top: 2px; }

    .card-main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; width: 100%; }
    .dmg-value { font-family: 'Arial Black', sans-serif; font-size: 48px; font-weight: 900; color: #fff; line-height: 1; }
    
    .card-footer { width: 100%; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
    .tier-label { font-size: 10px; color: #777; font-weight: 600; text-transform: uppercase; }
    .tier-value { font-family: 'Arial Black', sans-serif; font-size: 20px; color: #fff; }

    /* –°—Ç–∏–ª—å –Ω–∏–∂–Ω—å–æ–≥–æ –±–ª–æ–∫—É */
    .steps-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-gap: 10px;
      background: rgba(18, 21, 25, 0.7);
      padding: 15px;
      border-radius: 15px;
      border: var(--card-border);
      box-shadow: var(--panel-shadow);
      margin-top: 10px;
    }
    .grid-cell {
      width: 50px;
      height: 40px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Arial Black', sans-serif;
      font-size: 14px;
      color: #555;
      position: relative;
      transition: all 0.4s ease;
    }
    /* –ü–æ–º–∞—Ä–∞–Ω—á–µ–≤–∞ –æ–±–≤–æ–¥–∫–∞ –¥–ª—è 5 —Ç–∞ 8 —Å—Ö–æ–¥–∏–Ω–æ–∫ */
    .grid-cell.is-permanent {
      border: 2px solid var(--save-color);
      background: rgba(255, 170, 0, 0.05);
    }
    .grid-cell.current {
      color: var(--accent);
      border-color: var(--accent);
      background: rgba(0, 242, 255, 0.1);
      box-shadow: 0 0 15px rgba(0, 242, 255, 0.3);
      transform: scale(1.05);
    }
    /* –°—Ç–∏–ª—å —Ö—Ä–µ—Å—Ç–∏–∫–∞ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–∏—Ö */
    .grid-cell.passed::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ff3c3c' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cline x1='18' y1='6' x2='6' y2='18'%3E%3C/line%3E%3Cline x1='6' y1='6' x2='18' y2='18'%3E%3C/line%3E%3C/svg%3E");
      background-size: 70%;
      background-repeat: no-repeat;
      background-position: center;
      opacity: 0.8;
    }
    .grid-cell.passed { opacity: 0.4; filter: grayscale(1); }

    .progress-container {
      width: 100%; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; margin-top: 12px; overflow: hidden; display: none; 
    }
    .active .progress-container.has-data { display: block; }
    .progress-fill { height: 100%; width: 0%; transition: width 0.4s ease, background 0.4s ease; }
    .live-damage-text { font-family: 'Arial Black', sans-serif; font-size: 16px; font-weight: 900; margin-top: 5px; display: none; }
    .active .live-damage-text.has-data { display: block; }
    .tank-name-display { font-size: 10px; font-weight: 800; color: #fff; text-transform: uppercase; margin-top: auto; padding-bottom: 5px; display: none; letter-spacing: 0.5px; }
    .active .tank-name-display.has-tank { display: block; }

    .stamp {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-25deg) scale(3);
      border: 6px double var(--fail-color); color: var(--fail-color); padding: 5px 15px; font-family: 'Arial Black', sans-serif;
      font-size: 24px; text-transform: uppercase; opacity: 0; background: rgba(0,0,0,0.6); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 100; pointer-events: none;
    }
    .card.completed .stamp { opacity: 1; transform: translate(-50%, -50%) rotate(-25deg) scale(1); }
    
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    .active .status-icon { animation: pulse 1.5s infinite; }
  </style>
</head>
<body>

<div class="stats-bar">
  <div class="stat-box orange-style"><div class="stat-label">–ë–æ—ó</div><div id="totalBattles" class="stat-value">0</div></div>
  <div class="stat-box"><div class="stat-label">–í—ñ–Ω—Ä–µ–π—Ç</div><div id="winRate" class="stat-value">0%</div></div>
</div>

<div class="viewport"><div class="card-row" id="cardRow"></div></div>

<div class="steps-grid" id="stepsGrid">
  <div class="grid-cell" id="gc-0">1</div>
  <div class="grid-cell" id="gc-1">2</div>
  <div class="grid-cell" id="gc-2">3</div>
  <div class="grid-cell" id="gc-3">4</div>
  <div class="grid-cell is-permanent" id="gc-4">5</div>
  <div class="grid-cell" id="gc-5">6</div>
  <div class="grid-cell" id="gc-6">7</div>
  <div class="grid-cell is-permanent" id="gc-7">8</div>
  <div class="grid-cell" id="gc-8">9</div>
  <div class="grid-cell" id="gc-9">10</div>
</div>

<script>
  (function() {
    const SHEET_ID = "17phnEn-NW-OnrZg4DcW65r-Xoq6ScsdVjS5yL0SS3fk";
    const MY_PLAYER_ID = 594760646;
    const WS_URL = "ws://localhost:38200";

    const STEPS = [
      {s:1, t:4, dmg:1000, save:false}, {s:2, t:5, dmg:1500, save:false},
      {s:3, t:6, dmg:2000, save:false}, {s:4, t:7, dmg:2500, save:false},
      {s:5, t:8, dmg:3000, save:true }, {s:6, t:9, dmg:3500, save:false},
      {s:7, t:10, dmg:4500, save:false}, {s:8, t:10, dmg:5000, save:true },
      {s:9, t:11, dmg:5500, save:false}, {s:10, t:11, dmg:6000, save:false}
    ];

    let currentIdx = -1;
    let liveDamage = 0;
    let currentTankName = ""; 
    let isInitialized = false;

    function formatNum(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }

    function initCards() {
      const row = document.getElementById('cardRow');
      row.innerHTML = '';
      STEPS.forEach((step, i) => {
        const card = document.createElement('div');
        card.className = `card ${step.save ? 'is-save' : ''}`;
        card.id = `card-${i}`;
        card.innerHTML = `
          <div class="stamp">–í–∏–∫–æ–Ω–∞–Ω–æ</div>
          <div class="card-header">
            <div class="step-text">–°—Ö–æ–¥–∏–Ω–∫–∞ ${step.s}</div>
            <div class="save-label">${step.save ? '–ë–µ–∑–ø–µ—á–Ω–∞ –∑–æ–Ω–∞' : ''}</div>
            <div class="status-icon" id="icon-${i}">${step.save ? 'üõ°Ô∏è' : ''}</div>
          </div>
          <div class="card-main">
            <div class="dmg-value">${formatNum(step.dmg)}</div>
            <div id="prog-cont-${i}" class="progress-container">
              <div id="fill-${i}" class="progress-fill"></div>
            </div>
            <div id="live-txt-${i}" class="live-damage-text">0</div>
            <div id="tank-${i}" class="tank-name-display"></div>
          </div>
          <div class="card-footer">
            <div class="tier-label">–†—ñ–≤–µ–Ω—å —Ç–∞–Ω–∫—É: <span class="tier-value">${step.t}</span></div>
          </div>
        `;
        row.appendChild(card);
      });
      isInitialized = true;
    }

    function updateCarousel(idx, isFinished) {
      const row = document.getElementById('cardRow');
      const cards = document.querySelectorAll('.card');
      
      cards.forEach((card, i) => {
        card.classList.remove('active', 'prev', 'next', 'completed');
        const icon = document.getElementById(`icon-${i}`);
        const gridCell = document.getElementById(`gc-${i}`);
        
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∏–∂–Ω—å–æ—ó —Å—ñ—Ç–∫–∏
        gridCell.classList.remove('passed', 'current');
        if (i < idx || (isFinished && i === 9)) {
          gridCell.classList.add('passed');
        } else if (i === idx && !isFinished) {
          gridCell.classList.add('current');
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–µ–ª–∏–∫–∏—Ö –∫–∞—Ä—Ç–æ–∫
        if (i === idx) {
          card.classList.add('active');
          if (isFinished && i === 9) card.classList.add('completed');
          icon.innerHTML = (isFinished && i === 9) ? 'üëë' : 'üéØ';
        } else if (i === idx - 1) {
          card.classList.add('prev');
          icon.innerHTML = '‚úîÔ∏è';
        } else if (i === idx + 1) {
          card.classList.add('next');
          icon.innerHTML = STEPS[i].save ? 'üõ°Ô∏è' : '';
        } else {
          icon.innerHTML = i < idx ? '‚úîÔ∏è' : (STEPS[i].save ? 'üõ°Ô∏è' : '');
        }
      });

      const cardMoveWidth = 160; 
      row.style.transform = `translateX(-${idx * cardMoveWidth}px)`;
      currentIdx = idx;
      updateLiveUI();
    }

    function updateLiveUI() {
      const fill = document.getElementById(`fill-${currentIdx}`);
      const txt = document.getElementById(`live-txt-${currentIdx}`);
      const progCont = document.getElementById(`prog-cont-${currentIdx}`);
      const tankDisplay = document.getElementById(`tank-${currentIdx}`);
      
      if (!fill || !txt || !progCont) return;

      if (liveDamage > 0) {
        progCont.classList.add('has-data');
        txt.classList.add('has-data');
        const target = STEPS[currentIdx].dmg;
        const progressPercent = Math.min(100, (liveDamage / target) * 100);
        const hue = progressPercent * 1.2; 
        const dynamicColor = `hsl(${hue}, 100%, 50%)`;
        fill.style.width = progressPercent + "%";
        fill.style.background = dynamicColor;
        fill.style.boxShadow = `0 0 15px ${dynamicColor}`;
        txt.textContent = formatNum(liveDamage);
        txt.style.color = dynamicColor;
        if (liveDamage >= target) {
          fill.style.background = "var(--success-color)";
          txt.style.color = "var(--success-color)";
        }
      } else {
        progCont.classList.remove('has-data');
        txt.classList.remove('has-data');
      }

      if (tankDisplay) {
        if (currentTankName) {
          tankDisplay.textContent = currentTankName;
          tankDisplay.classList.add('has-tank');
        } else {
          tankDisplay.classList.remove('has-tank');
        }
      }
    }

    function connectWS() {
      const ws = new WebSocket(WS_URL);
      ws.onmessage = (e) => {
        try {
          const p = JSON.parse(e.data);
          if (p.type === "trigger" && p.path === "battle.onDamage") {
            if (p.value?.attacker?.playerId === MY_PLAYER_ID) {
              liveDamage += Number(p.value.damage) || 0;
              updateLiveUI();
            }
          }
          if (p.path?.includes("vehicleName") || p.path?.includes("vehicle.name")) {
              if (p.value) { currentTankName = p.value; updateLiveUI(); }
          }
          if (p.path === "battle.playerVehicle" && p.value?.name) {
              currentTankName = p.value.name; updateLiveUI();
          }
          if (p.type === "state" && p.path === "hangar.isInHangar" && p.value === true) {
            liveDamage = 0; updateLiveUI();
          }
        } catch(err) {}
      };
      ws.onclose = () => setTimeout(connectWS, 2000);
    }

    async function fetchData() {
      try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const data = json.table.rows.map(r => ({
          battleNo: r.c[0]?.v || 0,
          tier: r.c[3]?.v || 0,
          dmg: r.c[4]?.v || 0,
          isWin: r.c[7]?.v || 0
        })).filter(r => r.battleNo > 0).sort((a,b) => a.battleNo - b.battleNo);

        let tempIdx = 0, lastSaveIdx = 0, wins = 0, isFinished = false;
        data.forEach(r => {
          if (r.isWin === 1) wins++;
          let target = STEPS[tempIdx];
          if (r.tier === target.t) {
            if (r.dmg >= target.dmg) {
              if (tempIdx === 9) isFinished = true;
              else {
                tempIdx++;
                if (STEPS[tempIdx].save) lastSaveIdx = tempIdx;
              }
            } else {
              tempIdx = Math.max(tempIdx - 1, lastSaveIdx);
            }
          }
        });

        document.getElementById('totalBattles').textContent = data.length;
        const wr = data.length > 0 ? Math.round((wins / data.length) * 100) : 0;
        const wrEl = document.getElementById('winRate');
        wrEl.textContent = wr + '%';
        wrEl.style.color = wr >= 50 ? 'var(--success-color)' : 'var(--fail-color)';

        if (!isInitialized) initCards();
        updateCarousel(tempIdx, isFinished);
      } catch (e) { console.error(e); }
    }

    fetchData();
    connectWS();
    setInterval(fetchData, 4000);
  })();
</script>
</body>
</html>
