<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>WoT Ultimate HUD · Strict Logic</title>
  <style>
    :root {
      --accent: #00f2ff;
      --save-color: #ffaa00;
      --success-color: #00ff95;
      --fail-color: #ff3c3c;
      --card-bg: #121519;
      --view-width: 600px;
      --card-width: 200px;
      --card-gap: -40px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: transparent;
      font-family: 'Arial', 'Helvetica', sans-serif;
      color: #fff;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .stats-bar {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
      z-index: 10;
    }
    .stat-box {
      background: rgba(18, 21, 25, 0.95);
      border: 1px solid rgba(255,255,255,0.1);
      border-top: 3px solid var(--accent);
      padding: 10px 25px;
      border-radius: 10px;
      text-align: center;
      min-width: 130px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.7);
    }
    .stat-box.orange-style { border-top: 3px solid var(--save-color); }
    .stat-box.orange-style .stat-value { color: var(--save-color); }
    .stat-label { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 5px; }
    .stat-value { font-family: 'Arial Black', sans-serif; font-size: 28px; font-weight: 900; color: var(--accent); }

    .viewport {
      width: var(--view-width);
      height: 320px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      mask-image: linear-gradient(to right, transparent 0%, black 20%, black 80%, transparent 100%);
    }

    .card-row {
      display: flex;
      align-items: center;
      position: absolute;
      left: 0;
      transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
      padding-left: calc(var(--view-width) / 2 - var(--card-width) / 2);
    }

    .card {
      width: var(--card-width);
      height: 280px;
      background: var(--card-bg);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 18px;
      margin-right: var(--card-gap);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 15px;
      flex-shrink: 0;
      transition: all 0.6s ease;
      opacity: 0.2;
      transform: scale(0.85);
      filter: grayscale(1);
      position: relative;
      overflow: hidden;
    }

    .card.active { opacity: 1; transform: scale(1.1); border: 2px solid var(--accent); box-shadow: 0 0 50px rgba(0, 242, 255, 0.5); z-index: 50; filter: grayscale(0); }
    .card.is-save.active { border-color: var(--save-color); box-shadow: 0 0 50px rgba(255, 170, 0, 0.5); }

    .progress-container {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      margin-top: 12px;
      overflow: hidden;
      display: none; 
    }
    .active .progress-container.has-data { display: block; }
    
    .progress-fill {
      height: 100%;
      width: 0%;
      transition: width 0.4s ease, background 0.4s ease;
    }
    
    .live-damage-text {
      font-family: 'Arial Black', sans-serif;
      font-size: 16px;
      font-weight: 900;
      margin-top: 5px;
      display: none;
    }
    .active .live-damage-text.has-data { display: block; }

    .tank-name-display {
      font-size: 11px;
      font-weight: 800;
      color: #fff;
      text-transform: uppercase;
      margin-top: auto;
      padding-bottom: 8px; /* Трохи підняв над рисочкою */
      display: none;
      letter-spacing: 0.5px;
      text-shadow: 0 0 8px rgba(0,0,0,1);
    }
    .active .tank-name-display.has-tank { display: block; }

    .card-main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; width: 100%; }
    .step-text { font-family: 'Arial Black', sans-serif; font-size: 14px; font-weight: 900; color: var(--accent); margin-bottom: 4px; text-transform: uppercase; }
    .dmg-value { font-family: 'Arial Black', sans-serif; font-size: 52px; font-weight: 900; color: #fff; line-height: 1; }
    .card-footer { width: 100%; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; padding-bottom: 5px; }
    .tier-value { font-family: 'Arial Black', sans-serif; font-size: 24px; font-weight: 700; color: #fff; }
  </style>
</head>
<body>

<div class="stats-bar">
  <div class="stat-box orange-style"><div class="stat-label">Всього боїв</div><div id="totalBattles" class="stat-value">0</div></div>
  <div class="stat-box"><div class="stat-label">Вінрейт</div><div id="winRate" class="stat-value">0%</div></div>
</div>

<div class="viewport"><div class="card-row" id="cardRow"></div></div>

<script>
  (function() {
    const SHEET_ID = "17phnEn-NW-OnrZg4DcW65r-Xoq6ScsdVjS5yL0SS3fk";
    const MY_PLAYER_ID = 594760646;
    const WS_URL = "ws://localhost:38200";

    const STEPS = [
      {s:1, t:4, dmg:1000, save:false}, {s:2, t:5, dmg:1500, save:false},
      {s:3, t:6, dmg:2000, save:false}, {s:4, t:7, dmg:2500, save:false},
      {s:5, t:8, dmg:3000, save:true }, {s:6, t:9, dmg:3500, save:false},
      {s:7, t:10, dmg:4500, save:false}, {s:8, t:10, dmg:5000, save:true },
      {s:9, t:11, dmg:5500, save:false}, {s:10, t:11, dmg:6000, save:false}
    ];

    let currentIdx = -1;
    let liveDamage = 0;
    let currentTankName = ""; 

    function formatNum(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }

    function initCards() {
      const row = document.getElementById('cardRow');
      row.innerHTML = '';
      STEPS.forEach((step, i) => {
        const card = document.createElement('div');
        card.className = `card ${step.save ? 'is-save' : ''}`;
        card.id = `card-${i}`;
        card.innerHTML = `
          <div class="card-main">
            <div class="step-text">Сходинка ${step.s}</div>
            <div class="dmg-value">${formatNum(step.dmg)}</div>
            <div id="prog-cont-${i}" class="progress-container">
              <div id="fill-${i}" class="progress-fill"></div>
            </div>
            <div id="live-txt-${i}" class="live-damage-text">0</div>
            <div id="tank-${i}" class="tank-name-display"></div>
          </div>
          <div class="card-footer">
            <div class="tier-value">${step.t}</div>
          </div>
        `;
        row.appendChild(card);
      });
    }

    function updateCarousel(idx) {
      const row = document.getElementById('cardRow');
      const cards = document.querySelectorAll('.card');
      cards.forEach((card, i) => {
        card.classList.remove('active');
        if (i === idx) card.classList.add('active');
      });
      row.style.transform = `translateX(-${idx * 160}px)`;
      currentIdx = idx;
      updateLiveUI();
    }

    function updateLiveUI() {
      const fill = document.getElementById(`fill-${currentIdx}`);
      const txt = document.getElementById(`live-txt-${currentIdx}`);
      const progCont = document.getElementById(`prog-cont-${currentIdx}`);
      const tankDisplay = document.getElementById(`tank-${currentIdx}`);
      
      if (!fill || !txt || !progCont) return;

      if (liveDamage > 0) {
        progCont.classList.add('has-data');
        txt.classList.add('has-data');
        const target = STEPS[currentIdx].dmg;
        const progressPercent = Math.min(100, (liveDamage / target) * 100);
        fill.style.width = progressPercent + "%";
        fill.style.background = `hsl(${progressPercent * 1.2}, 100%, 50%)`;
        txt.textContent = formatNum(liveDamage);
      } else {
        progCont.classList.remove('has-data');
        txt.classList.remove('has-data');
      }

      if (tankDisplay) {
        if (currentTankName) {
          tankDisplay.textContent = currentTankName;
          tankDisplay.classList.add('has-tank');
        } else {
          tankDisplay.classList.remove('has-tank');
        }
      }
    }

    function connectWS() {
      const ws = new WebSocket(WS_URL);
      ws.onmessage = (e) => {
        try {
          const p = JSON.parse(e.data);
          
          // Дамаг
          if (p.type === "trigger" && p.path === "battle.onDamage") {
            if (p.value?.attacker?.playerId === MY_PLAYER_ID) {
              liveDamage += Number(p.value.damage) || 0;
              updateLiveUI();
            }
          }
          
          // НОВА ЛОГІКА НАЗВИ ТАНКА
          // Перевіряємо прямий шлях
          if (p.path?.includes("vehicleName")) {
              currentTankName = p.value;
              updateLiveUI();
          }
          
          // Перевіряємо список гравців у бою (найнадійніше при старті)
          if (p.path === "battle.players") {
              const me = Object.values(p.value).find(player => player.playerId === MY_PLAYER_ID);
              if (me && me.vehicleName) {
                  currentTankName = me.vehicleName;
                  updateLiveUI();
              }
          }

          if (p.type === "state" && p.path === "hangar.isInHangar" && p.value === true) {
            liveDamage = 0;
            updateLiveUI();
          }
        } catch(err) {}
      };
      ws.onclose = () => setTimeout(connectWS, 2000);
    }

    async function fetchData() {
      try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const data = json.table.rows.map(r => ({
          battleNo: r.c[0]?.v || 0,
          tier: r.c[3]?.v || 0,
          dmg: r.c[4]?.v || 0,
          isWin: r.c[7]?.v || 0
        })).filter(r => r.battleNo > 0).sort((a,b) => a.battleNo - b.battleNo);

        let tempIdx = 0, lastSaveIdx = 0;
        data.forEach(r => {
          let target = STEPS[tempIdx];
          if (r.tier === target.t) {
            if (r.dmg >= target.dmg) {
              if (tempIdx < 9) {
                tempIdx++;
                if (STEPS[tempIdx].save) lastSaveIdx = tempIdx;
              }
            } else {
              tempIdx = Math.max(tempIdx - 1, lastSaveIdx);
            }
          }
        });

        document.getElementById('totalBattles').textContent = data.length;
        if (!isInitialized) { initCards(); isInitialized = true; }
        updateCarousel(tempIdx);
      } catch (e) {}
    }

    let isInitialized = false;
    fetchData();
    connectWS();
    setInterval(fetchData, 4000);
  })();
</script>
</body>
</html>
